#!/usr/bin/env python3

import sys
import os
import requests
import json
from typing import Generator, List, Dict
import argparse
import subprocess
from enum import Enum, auto

# Ask Agent

# é…ç½®APIå‚æ•°
DEEPSEEK_API_KEY = os.getenv("DEEPSEEK_API_KEY")
DEEPSEEK_MODEL = "deepseek-chat"
DEEPSEEK_API_URL = "https://api.deepseek.com/v1/chat/completions"

# ç³»ç»Ÿé—®ç­”å·¥å…·åŠ©æ‰‹æç¤ºè¯
SYSTEM_PROMPT_ASK = """ä½ æ˜¯ä¸€ä¸ªç»ˆç«¯é—®ç­”å·¥å…·åŠ©æ‰‹ã€‚ä½ çš„ç‰¹ç‚¹æ˜¯ï¼š
1. å›ç­”ç®€æ´ã€ç›´æ¥ã€é«˜æ•ˆ
2. å¯¹å‘½ä»¤è¡Œã€è„šæœ¬ã€ç³»ç»Ÿç­‰æŠ€æœ¯é—®é¢˜æœ‰ä¸“é•¿
3. æä¾›çš„ä»£ç å’Œå‘½ä»¤å¯ä»¥ç›´æ¥åœ¨ç»ˆç«¯ä¸­ä½¿ç”¨
4. é¿å…å†—é•¿çš„è§£é‡Šï¼Œç”¨æˆ·æ›´åœ¨ä¹å¯ç”¨çš„ç­”æ¡ˆ
5. å¦‚æœæ˜¯å¤šè¡Œçš„è¾“å‡ºæˆ–ä»£ç ï¼Œç”¨æ¸…æ™°çš„æ ¼å¼å±•ç¤º"""
# ç³»ç»Ÿç¿»è¯‘æç¤ºè¯
SYSTEM_PROMPT_TRANSLATE = """ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„ç»ˆç«¯è‹±è¯­ç¿»è¯‘å·¥å…·ã€‚ä¸¥æ ¼éµå®ˆä»¥ä¸‹è§„åˆ™ï¼š
1. å°†è‹±è¯­å¥å­ç¿»è¯‘æˆä¸­æ–‡
2. å°†ä¸­æ–‡å¥å­ç¿»è¯‘æˆè‹±è¯­
3. è‹±è¯­å•è¯ï¼Œç¿»è¯‘æ—¶ç»™å‡ºéŸ³æ ‡ï¼Œç»™å‡ºå¸¸è§é‡Šä¹‰
4. ç¼©å†™è¯ç¿»è¯‘æ—¶ç»™å‡ºå…¨ç§°
5. ä½ åªæ‰§è¡Œç¿»è¯‘ç›¸å…³ä»»åŠ¡ï¼Œä¸å›ç­”éç¿»è¯‘é—®é¢˜ï¼Œä¸æä¾›é¢å¤–è§£é‡Šã€å»ºè®®æˆ–å¯¹è¯ã€‚

[è‹±è¯­å•è¯ç¿»è¯‘è¾“å‡ºæ ¼å¼]
å•è¯ [è‹±] [ç¾]
è¯æ€§. é‡Šä¹‰

[å•è¯ç¤ºä¾‹]
computer [kÉ™mËˆpjuËtÉ™(r)] [kÉ™mËˆpjuËtÉ™r]
n. è®¡ç®—æœºï¼Œç”µè„‘
"""
class agent_mode(Enum):
    ASK = auto()
    TRANSLATE = auto()

    def is_translate(self) -> bool:
        return self == agent_mode.TRANSLATE

current_mode = agent_mode.ASK    
# å¯¹è¯å†å²ç¼“å†²
messages: List[Dict[str, str]] = []
# æ˜¯å¦ä¸è®°å¿†ä¸Šä¸‹æ–‡
no_memory = False

def init_system_prompt(translate_mode: bool = False):
    """åˆå§‹åŒ–ç³»ç»Ÿæç¤ºè¯"""
    messages.clear()
    system_prompt = SYSTEM_PROMPT_TRANSLATE if translate_mode else SYSTEM_PROMPT_ASK
    messages.append({"role": "system", "content": system_prompt})

def get_streaming_response(prompt: str) -> str:
    """è·å–çœŸå®çš„APIæµå¼å“åº”ï¼ŒåŒ…å«å®Œæ•´çš„å¯¹è¯ä¸Šä¸‹æ–‡å’Œç³»ç»Ÿæç¤ºè¯"""
    headers = {
        "Authorization": f"Bearer {DEEPSEEK_API_KEY}",
        "Content-Type": "application/json",
        "Accept": "text/event-stream"
    }

    data = {
        "model": DEEPSEEK_MODEL,
        "messages": messages,
        "stream": True
    }

    assistant_message = ""

    with requests.post(DEEPSEEK_API_URL, headers=headers, json=data, stream=True) as response:
        if response.status_code != 200:
            print(f"âŒ APIé”™è¯¯: {response.status_code} {response.text}")
            return
        for chunk in response.iter_lines():
            if chunk:
                decoded = chunk.decode('utf-8')
                if decoded.startswith("data:"):
                    try:
                        data = json.loads(decoded[5:])
                        if "choices" in data and data["choices"][0]["delta"].get("content"):
                            content = data["choices"][0]["delta"]["content"]
                            assistant_message += content
                            print(content, end='', flush=True)
                    except json.JSONDecodeError:                                
                       continue        
        print('\n')  # æ¢è¡Œ

    return assistant_message

def command(command: str) -> bool:
    """å¤„ç†å‘½ä»¤"""
    global current_mode
    
    if command == 'exit':
        sys.exit(0)
    
    # è¿›å…¥ç¿»è¯‘æ¨¡å¼
    if command == '/e':
        current_mode = agent_mode.TRANSLATE
        init_system_prompt(translate_mode=True)
        print("âœ… å·²è¿›å…¥ç¿»è¯‘æ¨¡å¼\n")
        return
    
    # è¿›å…¥é—®ç­”æ¨¡å¼
    if command == '/ask':
        current_mode = agent_mode.ASK
        init_system_prompt(translate_mode=False)
        print("âœ… å·²è¿›å…¥é—®ç­”æ¨¡å¼\n")
        return
    
    # æ¸…ç©ºå¯¹è¯å†å²
    if command == '/reset':
        raise Exception("NotImplementedError")
        print("âœ… å·²æ¸…ç©ºå¯¹è¯å†å²\n")
        return
    
    # æ˜¾ç¤ºå¸®åŠ©
    if command == '/help':
        show_help()
        return

    # å¤„ç†shellå‘½ä»¤
    shell(command[1:])  # æå–å‘½ä»¤ï¼Œå»æ‰å‰é¢çš„ /

def show_help():
    """æ˜¾ç¤ºå¸®åŠ©ä¿¡æ¯"""
    help_text = """
ğŸ“– Ask Agent å‘½ä»¤å¸®åŠ©
ğŸ”¹ äº¤äº’æ¨¡å¼å‘½ä»¤ï¼š
  /ask          - è¿›å…¥é—®ç­”æ¨¡å¼
  /e            - è¿›å…¥ç¿»è¯‘æ¨¡å¼
  /reset        - æ¸…ç©ºå½“å‰å¯¹è¯å†å²
  /help         - æ˜¾ç¤ºæ­¤å¸®åŠ©ä¿¡æ¯
  /shell args   - æ‰§è¡Œshellå‘½ä»¤ï¼ˆå¦‚ /ls, /pwd, /cat file.txtï¼‰
  exit          - é€€å‡ºç¨‹åº
"""
    print(help_text)

def exec(cmd: str) -> str:
    """æ‰§è¡Œshellå‘½ä»¤å¹¶è¿”å›è¾“å‡º"""
    try:
        # æ‰§è¡Œshellå‘½ä»¤å¹¶æ•è·è¾“å‡º
        result = subprocess.run(
            cmd,
            shell=True,
            stdout= subprocess.PIPE,
            stderr=subprocess.STDOUT,  # å°†stderré‡å®šå‘åˆ°stdout
            text=True,
            timeout=10
        )
        
        output = result.stdout
        
        return output.strip() if output else "(æ— è¾“å‡º)"
    except subprocess.TimeoutExpired:
        return "âŒ å‘½ä»¤æ‰§è¡Œè¶…æ—¶"
    except Exception as e:
        return f"âŒ å‘½ä»¤æ‰§è¡Œé”™è¯¯: {str(e)}"
    
def shell(cmd: str) -> bool:
    """å¤„ç†shellå‘½ä»¤ï¼Œæ·»åŠ åˆ°å†å²å¹¶æ‰§è¡Œ"""
    # å°†å‘½ä»¤æ·»åŠ åˆ°æ¶ˆæ¯å†å²
    messages.append({"role": "user", "content": f"æ‰§è¡Œshellå‘½ä»¤: {cmd}"})
    
    # æ‰§è¡Œå‘½ä»¤
    output = exec(cmd)
    
    # è¾“å‡ºåˆ°ç»ˆç«¯
    print(output)
    
    # å°†è¾“å‡ºæ·»åŠ åˆ°æ¶ˆæ¯å†å²
    messages.append({"role": "user", "content": f"Shellå‘½ä»¤æ‰§è¡Œç»“æœ:\n{output}"})

def ask(question: str) -> str:
    """å¤„ç†æ™®é€šé—®é¢˜ï¼Œæ·»åŠ åˆ°å†å²å¹¶è·å–å›ç­”"""
    # å°†ç”¨æˆ·æ–°æ¶ˆæ¯æ·»åŠ åˆ°æ¶ˆæ¯åˆ—è¡¨
    messages.append({"role": "user", "content": question})
    # è°ƒç”¨APIè·å–æµå¼å“åº”
    answer =  get_streaming_response(question)
    # å°†åŠ©æ‰‹å›å¤æ·»åŠ åˆ°æ¶ˆæ¯åˆ—è¡¨
    messages.append({"role": "assistant", "content": answer})
    
    # å¦‚æœå¯ç”¨ä¸è®°å¿†æ¨¡å¼ï¼Œæ¸…ç©ºå†å²ï¼ˆä¿ç•™ç³»ç»Ÿæç¤ºè¯ï¼‰
    if no_memory:
        init_system_prompt(translate_mode=current_mode.is_translate())
    
    return answer   
   
def chat_loop():
    """ä¸»èŠå¤©å¾ªç¯ï¼Œæ”¯æŒå®Œæ•´çš„å¯¹è¯ä¸Šä¸‹æ–‡å’Œå¯¹è¯å‘½ä»¤"""

    while True:
        user_input = input("ğŸ’¬^ :\n").strip()
        if not user_input:
            continue

        # å¤„ç†ç‰¹æ®Šå‘½ä»¤
        if user_input.startswith('/'):    
            command(user_input.lower()) 
            continue
        
        print("\nğŸ¤– Assistant: ", flush=True)

        # è·å–å›ç­”å¹¶æ‰“å°
        ask(user_input)
        
        # ç¿»è¯‘æ¨¡å¼ä¸‹ï¼Œæ¯æ¬¡å›ç­”åæ¸…é™¤æ¶ˆæ¯å†å²ï¼ˆä¿ç•™ç³»ç»Ÿæç¤ºè¯ï¼‰
        if current_mode.is_translate():
            init_system_prompt(translate_mode=True) 
        

def restore_tty():
    """é‡æ–°æ‰“å¼€ stdin ç”¨äºäº¤äº’"""
    if sys.stdin.isatty():
        return
    if sys.platform != 'win32':
        sys.stdin = open('/dev/tty')
    else:
        sys.stdin = open('CON', 'r')

def pipe_mode(prompt: str = None, quit: bool = False, continue_conversation: bool = False):
    """ç®¡é“æ¨¡å¼ï¼šæ”¯æŒç®¡é“è¾“å…¥ + é¢å¤–é—®é¢˜ç»„åˆ"""
    stdin_input = None
    
    # æ£€æŸ¥æ˜¯å¦æœ‰æ¥è‡ªç®¡é“çš„è¾“å…¥
    if not sys.stdin.isatty():
        stdin_input = sys.stdin.read().strip()
    
    # ç»„åˆç®¡é“è¾“å…¥å’Œå‘½ä»¤è¡Œå‚æ•°
    if stdin_input and prompt:
        # å¦‚æœæ—¢æœ‰ç®¡é“è¾“å…¥åˆæœ‰å‚æ•°ï¼Œç»„åˆå®ƒä»¬
        combined_prompt = f"{stdin_input}\n\n---\n\n{prompt}"
    elif stdin_input:
        # åªæœ‰ç®¡é“è¾“å…¥
        combined_prompt = stdin_input
    elif prompt:
        # åªæœ‰å‘½ä»¤è¡Œå‚æ•°
        combined_prompt = prompt
    else:
        # éƒ½æ²¡æœ‰
        print("âŒ é”™è¯¯: éœ€è¦æä¾›è¾“å…¥å†…å®¹", file=sys.stderr)
        sys.exit(1)
    
    ask(combined_prompt)
        
    # å¦‚æœå¯ç”¨è¿ç»­å¯¹è¯ï¼Œåˆ™è¿›å…¥äº¤äº’æ¨¡å¼
    if not continue_conversation and not (prompt and not quit):
        return
    
    restore_tty()
    chat_loop()

def main():
    if not DEEPSEEK_API_KEY:
        print("âŒ é”™è¯¯: æœªè®¾ç½® DEEPSEEK_API_KEY ç¯å¢ƒå˜é‡", file=sys.stderr)
        sys.exit(1)

    parser = argparse.ArgumentParser(
        description="Ask Agent - DeepSeek é—®ç­”å®¢æˆ·ç«¯",
        prog="ag"
    )
    parser.add_argument(
        "query",
        nargs="*",       # æ¥æ”¶å¤šä¸ªå‚æ•°
        help="è¦æé—®çš„å†…å®¹ï¼ˆå¦‚æœæœªæä¾›ï¼Œå°†ä»æ ‡å‡†è¾“å…¥è¯»å–ï¼‰"
    )
    parser.add_argument(
        "-q", "--quit",
        action="store_true",
        help="ä¸€é—®ä¸€ç­”æ¨¡å¼ï¼Œå›ç­”åç›´æ¥é€€å‡ºï¼ˆé»˜è®¤ä¸ºè¿ç»­å¯¹è¯ï¼‰"
    )
    parser.add_argument(
        "-a", "--after",
        action="store_true",
        help="ç®¡é“æ¨¡å¼ä¸­ï¼Œå›ç­”åè¿›å…¥è¿ç»­å¯¹è¯æ¨¡å¼"
    )
    parser.add_argument(
        "-e", "--translate",
        action="store_true",
        help="è¿›å…¥ç¿»è¯‘æ¨¡å¼"
    )
    parser.add_argument(
        "-n", "--no-memory",
        action="store_true",
        help="ä¸è®°å¿†ä¸Šä¸‹æ–‡ï¼Œæ¯æ¬¡é—®ç­”ååªä¿ç•™ç³»ç»Ÿæç¤ºè¯"
    )
    
    args = parser.parse_args()

    # åˆå§‹åŒ–ç³»ç»Ÿæç¤ºè¯
    init_system_prompt(args.translate)
    
    # æ›´æ–°å½“å‰æ¨¡å¼
    if args.translate:
        global current_mode
        current_mode = agent_mode.TRANSLATE
    
    # è®¾ç½®ä¸è®°å¿†æ¨¡å¼
    global no_memory
    no_memory = args.no_memory

    # å°†å¤šä¸ªå‚æ•°è¿æ¥æˆä¸€ä¸ªå­—ç¬¦ä¸²
    query = " ".join(args.query) if args.query else None
    
    try:
        # å¦‚æœæä¾›äº†æŸ¥è¯¢æˆ–è¾“å…¥æ¥è‡ªç®¡é“ï¼Œä½¿ç”¨ç®¡é“æ¨¡å¼
        if query or (not sys.stdin.isatty()):
            pipe_mode(query, args.quit, args.after)
        else:
            # å¦åˆ™è¿›å…¥äº¤äº’æ¨¡å¼
            chat_loop()
    except (KeyboardInterrupt, EOFError):
       sys.exit(1)
    except Exception as e:
        print(f"\nâŒ å‘ç”Ÿé”™è¯¯: {e}")

if __name__ == "__main__":
    main()        