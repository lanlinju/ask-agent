#!/usr/bin/env python3

import sys
import os
import requests
import json
from typing import Generator, List, Dict
import argparse

# Ask Agent

# é…ç½®APIå‚æ•°
DEEPSEEK_API_KEY = os.getenv("DEEPSEEK_API_KEY")
if not DEEPSEEK_API_KEY:
    print("âŒ é”™è¯¯: æœªè®¾ç½® DEEPSEEK_API_KEY ç¯å¢ƒå˜é‡", file=sys.stderr)
    sys.exit(1)

DEEPSEEK_API_URL = "https://api.deepseek.com/v1/chat/completions"
DEEPSEEK_MODEL = "deepseek-chat"

# ç³»ç»Ÿæç¤ºè¯
SYSTEM_PROMPT = """ä½ æ˜¯ä¸€ä¸ªç»ˆç«¯é—®ç­”å·¥å…·åŠ©æ‰‹ã€‚ä½ çš„ç‰¹ç‚¹æ˜¯ï¼š
1. å›ç­”ç®€æ´ã€ç›´æ¥ã€é«˜æ•ˆ
2. å¯¹å‘½ä»¤è¡Œã€è„šæœ¬ã€ç³»ç»Ÿç­‰æŠ€æœ¯é—®é¢˜æœ‰ä¸“é•¿
3. æä¾›çš„ä»£ç å’Œå‘½ä»¤å¯ä»¥ç›´æ¥åœ¨ç»ˆç«¯ä¸­ä½¿ç”¨
4. é¿å…å†—é•¿çš„è§£é‡Šï¼Œç”¨æˆ·æ›´åœ¨ä¹å¯ç”¨çš„ç­”æ¡ˆ
5. å¦‚æœæ˜¯å¤šè¡Œçš„è¾“å‡ºæˆ–ä»£ç ï¼Œç”¨æ¸…æ™°çš„æ ¼å¼å±•ç¤º"""

# å¯¹è¯å†å²ç¼“å†²
messages: List[Dict[str, str]] = [{"role": "system", "content": SYSTEM_PROMPT}]

def get_streaming_response(prompt: str) -> Generator[str, None, None]:
    """è·å–çœŸå®çš„APIæµå¼å“åº”ï¼ŒåŒ…å«å®Œæ•´çš„å¯¹è¯ä¸Šä¸‹æ–‡å’Œç³»ç»Ÿæç¤ºè¯"""
    headers = {
        "Authorization": f"Bearer {DEEPSEEK_API_KEY}",
        "Content-Type": "application/json",
        "Accept": "text/event-stream"
    }

    # å°†ç”¨æˆ·æ–°æ¶ˆæ¯æ·»åŠ åˆ°æ¶ˆæ¯åˆ—è¡¨
    messages.append({"role": "user", "content": prompt})

    data = {
        "model": DEEPSEEK_MODEL,
        "messages": messages,
        "stream": True
    }

    assistant_message = ""

    with requests.post(DEEPSEEK_API_URL, headers=headers, json=data, stream=True) as response:
        if response.status_code != 200:
            print(f"âŒ APIé”™è¯¯: {response.status_code} {response.text}")
            return
        for chunk in response.iter_lines():
            if chunk:
                decoded = chunk.decode('utf-8')
                if decoded.startswith("data:"):
                    try:
                        data = json.loads(decoded[5:])
                        if "choices" in data and data["choices"][0]["delta"].get("content"):
                            content = data["choices"][0]["delta"]["content"]
                            assistant_message += content
                            yield content
                    except json.JSONDecodeError:                                
                       continue        

    # å°†åŠ©æ‰‹å›å¤æ·»åŠ åˆ°å†å²
    messages.append({"role": "assistant", "content": assistant_message})

def chat_loop():
    """ä¸»èŠå¤©å¾ªç¯ï¼Œæ”¯æŒå®Œæ•´çš„å¯¹è¯ä¸Šä¸‹æ–‡å’Œå¯¹è¯å‘½ä»¤"""
    # print("ğŸ¤– DeepSeek Ask Agent å®¢æˆ·ç«¯ (è¾“å…¥ 'exit' é€€å‡ºï¼Œè¾“å…¥ '/help' æŸ¥çœ‹å‘½ä»¤)\n")

    while True:
        try:
            user_input = input("ğŸ’¬^ :\n").strip()
            if not user_input:
                continue
            
            # å¤„ç†ç‰¹æ®Šå‘½ä»¤
            if user_input.lower() == 'exit':
                break
            
            print("\nğŸ¤– Assistant: ", flush=True)

            # è°ƒç”¨APIè·å–æµå¼å“åº”
            for chunk in get_streaming_response(user_input):
                print(chunk, end='', flush=True)

            print('\n')  # æ¢è¡Œ
            
        except (KeyboardInterrupt, EOFError):
            break
        except Exception as e:
            print(f"\nâŒ å‘ç”Ÿé”™è¯¯: {e}")

def restore_tty():
    """é‡æ–°æ‰“å¼€ stdin ç”¨äºäº¤äº’"""
    if sys.stdin.isatty():
        return
    if sys.platform != 'win32':
        sys.stdin = open('/dev/tty')
    else:
        sys.stdin = open('CON', 'r')

def pipe_mode(prompt: str = None, quit: bool = False, continue_conversation: bool = False):
    """ç®¡é“æ¨¡å¼ï¼šæ”¯æŒç®¡é“è¾“å…¥ + é¢å¤–é—®é¢˜ç»„åˆ"""
    stdin_input = None
    
    # æ£€æŸ¥æ˜¯å¦æœ‰æ¥è‡ªç®¡é“çš„è¾“å…¥
    if not sys.stdin.isatty():
        stdin_input = sys.stdin.read().strip()
    
    # ç»„åˆç®¡é“è¾“å…¥å’Œå‘½ä»¤è¡Œå‚æ•°
    if stdin_input and prompt:
        # å¦‚æœæ—¢æœ‰ç®¡é“è¾“å…¥åˆæœ‰å‚æ•°ï¼Œç»„åˆå®ƒä»¬
        combined_prompt = f"{stdin_input}\n\n---\n\n{prompt}"
    elif stdin_input:
        # åªæœ‰ç®¡é“è¾“å…¥
        combined_prompt = stdin_input
    elif prompt:
        # åªæœ‰å‘½ä»¤è¡Œå‚æ•°
        combined_prompt = prompt
    else:
        # éƒ½æ²¡æœ‰
        print("âŒ é”™è¯¯: éœ€è¦æä¾›è¾“å…¥å†…å®¹", file=sys.stderr)
        sys.exit(1)
    
    try:
        # è·å–æµå¼å“åº”å¹¶ç›´æ¥è¾“å‡º
        for chunk in get_streaming_response(combined_prompt):
            print(chunk, end='', flush=True)
        print('\n')  # æœ€åæ·»åŠ æ¢è¡Œ
    except Exception as e:
        print(f"âŒ é”™è¯¯: {e}", file=sys.stderr)
        sys.exit(1)

    # å¦‚æœå¯ç”¨è¿ç»­å¯¹è¯ï¼Œåˆ™è¿›å…¥äº¤äº’æ¨¡å¼
    if not continue_conversation and not (prompt and not quit):
        return
    
    restore_tty()
    chat_loop()

if __name__ == "__main__":
    parser = argparse.ArgumentParser(
        description="Ask Agent - DeepSeek èŠå¤©å®¢æˆ·ç«¯",
        prog="ag"
    )
    parser.add_argument(
        "query",
        nargs="*",       # æ¥æ”¶å¤šä¸ªå‚æ•°
        help="è¦æé—®çš„å†…å®¹ï¼ˆå¦‚æœæœªæä¾›ï¼Œå°†ä»æ ‡å‡†è¾“å…¥è¯»å–ï¼‰"
    )
    parser.add_argument(
        "-q", "--quit",
        action="store_true",
        help="ä¸€é—®ä¸€ç­”æ¨¡å¼ï¼Œå›ç­”åç›´æ¥é€€å‡ºï¼ˆé»˜è®¤ä¸ºè¿ç»­å¯¹è¯ï¼‰"
    )
    parser.add_argument(
        "-a", "--after",
        action="store_true",
        help="ç®¡é“æ¨¡å¼ä¸­ï¼Œå›ç­”åè¿›å…¥è¿ç»­å¯¹è¯æ¨¡å¼"
    )
    
    args = parser.parse_args()

    # å°†å¤šä¸ªå‚æ•°è¿æ¥æˆä¸€ä¸ªå­—ç¬¦ä¸²
    query = " ".join(args.query) if args.query else None
    
    # å¦‚æœæä¾›äº†æŸ¥è¯¢æˆ–è¾“å…¥æ¥è‡ªç®¡é“ï¼Œä½¿ç”¨ç®¡é“æ¨¡å¼
    if query or (not sys.stdin.isatty()):
        pipe_mode(query, args.quit, args.after)
    else:
        # å¦åˆ™è¿›å…¥äº¤äº’æ¨¡å¼
        chat_loop()
