#!/usr/bin/env python3

import sys
import os
import requests
import json
from typing import Generator, List, Dict
import argparse

# Ask Agent

# é…ç½®APIå‚æ•°
DEEPSEEK_API_KEY = os.getenv("DEEPSEEK_API_KEY")
if not DEEPSEEK_API_KEY:
    print("âŒ é”™è¯¯: æœªè®¾ç½® DEEPSEEK_API_KEY ç¯å¢ƒå˜é‡", file=sys.stderr)
    sys.exit(1)

DEEPSEEK_API_URL = "https://api.deepseek.com/v1/chat/completions"
DEEPSEEK_MODEL = "deepseek-chat"

# ç³»ç»Ÿæç¤ºè¯
SYSTEM_PROMPT = """ä½ æ˜¯ä¸€ä¸ªç»ˆç«¯é—®ç­”å·¥å…·åŠ©æ‰‹ã€‚ä½ çš„ç‰¹ç‚¹æ˜¯ï¼š
1. å›ç­”ç®€æ´ã€ç›´æ¥ã€é«˜æ•ˆ
2. å¯¹å‘½ä»¤è¡Œã€è„šæœ¬ã€ç³»ç»Ÿç­‰æŠ€æœ¯é—®é¢˜æœ‰ä¸“é•¿
3. æä¾›çš„ä»£ç å’Œå‘½ä»¤å¯ä»¥ç›´æ¥åœ¨ç»ˆç«¯ä¸­ä½¿ç”¨
4. é¿å…å†—é•¿çš„è§£é‡Šï¼Œç”¨æˆ·æ›´åœ¨ä¹å¯ç”¨çš„ç­”æ¡ˆ
5. å¦‚æœæ˜¯å¤šè¡Œçš„è¾“å‡ºæˆ–ä»£ç ï¼Œç”¨æ¸…æ™°çš„æ ¼å¼å±•ç¤º"""

# å¯¹è¯å†å²ç¼“å†²
conversation_history: List[Dict[str, str]] = []

def get_streaming_response(prompt: str) -> Generator[str, None, None]:
    """è·å–çœŸå®çš„APIæµå¼å“åº”ï¼ŒåŒ…å«å®Œæ•´çš„å¯¹è¯ä¸Šä¸‹æ–‡å’Œç³»ç»Ÿæç¤ºè¯"""
    headers = {
        "Authorization": f"Bearer {DEEPSEEK_API_KEY}",
        "Content-Type": "application/json",
        "Accept": "text/event-stream"
    }

    # å¦‚æœè¿™æ˜¯ç¬¬ä¸€æ¡æ¶ˆæ¯ï¼Œæ·»åŠ ç³»ç»Ÿæç¤ºè¯
    messages = []
    if not conversation_history:
        messages.append({"role": "system", "content": SYSTEM_PROMPT})
    
    # å°†ä¹‹å‰çš„å¯¹è¯å†å²åŠ å…¥
    messages.extend(conversation_history)
    # å°†ç”¨æˆ·æ–°æ¶ˆæ¯æ·»åŠ åˆ°å†å²
    messages.append({"role": "user", "content": prompt})
    conversation_history.append({"role": "user", "content": prompt})

    data = {
        "model": DEEPSEEK_MODEL,
        "messages": messages,
        "stream": True
    }

    assistant_message = ""

    with requests.post(DEEPSEEK_API_URL, headers=headers, json=data, stream=True) as response:
        for chunk in response.iter_lines():
            if chunk:
                decoded = chunk.decode('utf-8')
                if decoded.startswith("data:"):
                    try:
                        data = json.loads(decoded[5:])
                        if "choices" in data and data["choices"][0]["delta"].get("content"):
                            content = data["choices"][0]["delta"]["content"]
                            assistant_message += content
                            yield content
                    except json.JSONDecodeError:                                
                       continue        

    # å°†åŠ©æ‰‹å›å¤æ·»åŠ åˆ°å†å²
    conversation_history.append({"role": "assistant", "content": assistant_message})

def chat_loop(quit_after_answer: bool = False):
    """ä¸»èŠå¤©å¾ªç¯ï¼Œæ”¯æŒå®Œæ•´çš„å¯¹è¯ä¸Šä¸‹æ–‡å’Œå¯¹è¯å‘½ä»¤"""
    print("ğŸ¤– DeepSeek Ask Agent å®¢æˆ·ç«¯ (è¾“å…¥ 'exit' é€€å‡ºï¼Œè¾“å…¥ '/help' æŸ¥çœ‹å‘½ä»¤)\n")

    # æ£€æŸ¥ stdin æ˜¯å¦å¯ç”¨ï¼ˆæ˜¯å¦æ˜¯ç»ˆç«¯ï¼‰
    if not sys.stdin.isatty():
        print("âŒ é”™è¯¯: æ— æ³•åœ¨éäº¤äº’å¼ç¯å¢ƒä¸­ä½¿ç”¨äº¤äº’æ¨¡å¼", file=sys.stderr)
        sys.exit(1)

    while True:
        try:
            user_input = input("ğŸ’¬^ : ").strip()
            if not user_input:
                continue
            
            # å¤„ç†ç‰¹æ®Šå‘½ä»¤
            if user_input.lower() == 'exit':
                break
            elif user_input.lower() == '/help':
                print("\nğŸ“‹ å¯ç”¨å‘½ä»¤:")
                print("  /help        - æ˜¾ç¤ºå¸®åŠ©ä¿¡æ¯")
                print("  /history, /h - æ˜¾ç¤ºå¯¹è¯å†å²")
                print("  /clear, /c   - æ¸…é™¤å¯¹è¯å†å²")
                print("  exit         - é€€å‡ºç¨‹åº\n")
                continue
            elif user_input.lower() in ['/history', '/h']:
                show_history()
                print()
                continue
            elif user_input.lower() in ['/clear', '/c']:
                clear_history()
                print()
                continue
            
            # æ™®é€šå¯¹è¯
            print("\nğŸ¤– Assistant: ", flush=True)
            try:
                # è°ƒç”¨çœŸå®APIè·å–æµå¼å“åº”ï¼ˆåŒ…å«å®Œæ•´å¯¹è¯å†å²ï¼‰
                for chunk in get_streaming_response(user_input):
                    print(chunk, end='', flush=True)
                print()  # æ¢è¡Œ
            except Exception as e:
                print(f"\nâŒ å‘ç”Ÿé”™è¯¯: {e}")
            
            print()  # æ¢è¡Œ

            # å¦‚æœè®¾ç½®äº†ä¸€é—®ä¸€ç­”æ¨¡å¼ï¼Œå›ç­”åé€€å‡º
            if quit_after_answer:
                break

        except (KeyboardInterrupt, EOFError):
            break
        except Exception as e:
            print(f"\nå‘ç”Ÿé”™è¯¯: {e}")

def clear_history():
    """æ¸…é™¤å¯¹è¯å†å²"""
    global conversation_history
    conversation_history = []
    print("âœ¨ å¯¹è¯å†å²å·²æ¸…é™¤")

def show_history():
    """æ˜¾ç¤ºå¯¹è¯å†å²"""
    if not conversation_history:
        print("ğŸ“­ å¯¹è¯å†å²ä¸ºç©º")
        return
    
    print("\nğŸ“œ === å¯¹è¯å†å² ===")
    for i, msg in enumerate(conversation_history, 1):
        role = "ğŸ‘¤ ç”¨æˆ·" if msg["role"] == "user" else "ğŸ¤– åŠ©æ‰‹"
        print(f"\n[{i}] {role}:")
        print(msg["content"])

def pipe_mode(prompt: str = None, continue_conversation: bool = False):
    """ç®¡é“æ¨¡å¼ï¼šæ”¯æŒç®¡é“è¾“å…¥ + é¢å¤–é—®é¢˜ç»„åˆ"""
    stdin_input = None
    
    # æ£€æŸ¥æ˜¯å¦æœ‰æ¥è‡ªç®¡é“çš„è¾“å…¥
    if not sys.stdin.isatty():
        stdin_input = sys.stdin.read().strip()
    
    # ç»„åˆç®¡é“è¾“å…¥å’Œå‘½ä»¤è¡Œå‚æ•°
    if stdin_input and prompt:
        # å¦‚æœæ—¢æœ‰ç®¡é“è¾“å…¥åˆæœ‰å‚æ•°ï¼Œç»„åˆå®ƒä»¬
        combined_prompt = f"{stdin_input}\n\n---\n\n{prompt}"
    elif stdin_input:
        # åªæœ‰ç®¡é“è¾“å…¥
        combined_prompt = stdin_input
    elif prompt:
        # åªæœ‰å‘½ä»¤è¡Œå‚æ•°
        combined_prompt = prompt
    else:
        # éƒ½æ²¡æœ‰
        print("âŒ é”™è¯¯: éœ€è¦æä¾›è¾“å…¥å†…å®¹", file=sys.stderr)
        sys.exit(1)
    
    try:
        # è·å–æµå¼å“åº”å¹¶ç›´æ¥è¾“å‡º
        for chunk in get_streaming_response(combined_prompt):
            print(chunk, end='', flush=True)
        print()  # æœ€åæ·»åŠ æ¢è¡Œ
    except Exception as e:
        print(f"âŒ é”™è¯¯: {e}", file=sys.stderr)
        sys.exit(1)
    
    # å¦‚æœå¯ç”¨è¿ç»­å¯¹è¯ï¼Œåˆ™è¿›å…¥äº¤äº’æ¨¡å¼
    if continue_conversation:
        print("\nğŸ’¬ è¿›å…¥è¿ç»­å¯¹è¯æ¨¡å¼ (è¾“å…¥ 'exit' é€€å‡º):\n")
        # é‡æ–°æ‰“å¼€ stdin ç”¨äºäº¤äº’
        import tty
        import termios
        sys.stdin = open('/dev/tty')
        chat_loop(quit_after_answer=False)

if __name__ == "__main__":
    parser = argparse.ArgumentParser(
        description="Ask Agent - DeepSeek èŠå¤©å®¢æˆ·ç«¯",
        prog="ag"
    )
    parser.add_argument(
        "query",
        nargs="*",       # æ¥æ”¶å¤šä¸ªå‚æ•°
        help="è¦æé—®çš„å†…å®¹ï¼ˆå¦‚æœæœªæä¾›ï¼Œå°†ä»æ ‡å‡†è¾“å…¥è¯»å–ï¼‰"
    )
    parser.add_argument(
        "-q", "--quit",
        action="store_true",
        help="ä¸€é—®ä¸€ç­”æ¨¡å¼ï¼Œå›ç­”åç›´æ¥é€€å‡ºï¼ˆé»˜è®¤ä¸ºè¿ç»­å¯¹è¯ï¼‰"
    )
    parser.add_argument(
        "-a", "--after",
        action="store_true",
        help="ç®¡é“æ¨¡å¼ä¸­ï¼Œå›ç­”åè¿›å…¥è¿ç»­å¯¹è¯æ¨¡å¼"
    )
    
    args = parser.parse_args()

    # å°†å¤šä¸ªå‚æ•°è¿æ¥æˆä¸€ä¸ªå­—ç¬¦ä¸²
    query = " ".join(args.query) if args.query else None
    
    # å¦‚æœæä¾›äº†æŸ¥è¯¢æˆ–è¾“å…¥æ¥è‡ªç®¡é“ï¼Œä½¿ç”¨ç®¡é“æ¨¡å¼
    if query or (not sys.stdin.isatty()):
        pipe_mode(query, args.after)
    else:
        # å¦åˆ™è¿›å…¥äº¤äº’æ¨¡å¼
        chat_loop(args.quit)
